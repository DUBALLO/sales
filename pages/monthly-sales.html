<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>월별 매출 분석</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/monthly-sales.js"></script>
</head>
<body>
<nav>
  <a href="../index.html">홈</a>
  <a href="./customer-analysis.html">고객 분석</a>
  <a href="./monthly-sales.html">월별 매출</a>
</nav>
<h1>월별 매출 분석</h1>
<div>
  <label>시작 연도 <input id="startYear" type="number" placeholder="YYYY"></label>
  <label>시작 월   <input id="startMonth" type="number" placeholder="MM"></label>
  <label>종료 연도 <input id="endYear" type="number" placeholder="YYYY"></label>
  <label>종료 월   <input id="endMonth" type="number" placeholder="MM"></label>
  <button id="searchBtn">조회</button>
  <button id="uploadBtn">CSV 업로드</button>
  <button id="exportBtn">CSV 다운로드</button>
  <div id="uploadPanel" style="display:none;">
    <input id="fileInput" type="file" accept=".csv">
    <button id="confirmUploadBtn">업로드</button>
    <button id="cancelUploadBtn">취소</button>
  </div>
</div>

<table id="monthlyTable" border="1">
  <thead>
    <tr>
      <th>월</th><th>주문수량</th><th>주문금액</th>
      <th>관급수량</th><th>관급금액</th>
      <th>사급수량</th><th>사급금액</th><th>합계</th>
    </tr>
  </thead>
  <tbody id="monthlyTableBody"></tbody>
  <tfoot>
    <tr>
      <td>합계</td>
      <td id="totalOrderCount"></td>
      <td id="totalOrderAmount"></td>
      <td id="totalGovCount"></td>
      <td id="totalGovAmount"></td>
      <td id="totalPrivCount"></td>
      <td id="totalPrivAmount"></td>
      <td id="grandTotal"></td>
    </tr>
  </tfoot>
</table>

<div id="detailSection" style="display:none;">
  <h2 id="detailTitle">상세 정보</h2>
  <button id="closeDetailBtn">닫기</button>
  <table border="1">
    <thead>
      <tr><th>주문 일자</th><th>고객명</th><th>품명</th><th>수량</th><th>금액</th><th>구분</th></tr>
    </thead>
    <tbody id="detailTableBody"></tbody>
  </table>
</div>

<script>
  // 페이지 로드시 Google 시트 CSV 로드
  document.addEventListener('DOMContentLoaded', () => {
    try {
      if (typeof loadSampleData === 'function') loadSampleData();
      else if (typeof loadSalesData === 'function') loadSalesData();
    } catch (e) {
      if (window.CommonUtils) CommonUtils.showAlert('데이터 로드 중 오류가 발생했습니다.', 'error');
    }
  });

  // 조회 버튼: 월별 보고서 생성
  document.getElementById('searchBtn').addEventListener('click', () => {
    if (typeof generateReport === 'function') generateReport();
  });

  // CSV 업로드 패널 토글
  document.getElementById('uploadBtn').addEventListener('click', () => {
    const panel = document.getElementById('uploadPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  });
  document.getElementById('cancelUploadBtn').addEventListener('click', () => {
    document.getElementById('uploadPanel').style.display = 'none';
  });

  // CSV 파일 업로드 처리
  document.getElementById('confirmUploadBtn').addEventListener('click', () => {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        if (typeof parseCSV === 'function') {
          // monthly-sales.js의 전역변수 salesData를 덮어쓴 후 다시 보고서를 생성
          salesData = parseCSV(e.target.result);
          if (typeof generateReport === 'function') generateReport();
        }
      };
      reader.readAsText(file);
    }
  });

  // CSV 다운로드
  document.getElementById('exportBtn').addEventListener('click', () => {
    if (typeof exportData === 'function') {
      exportData();
    } else {
      // 간단한 CSV 변환(테이블 내용을 문자열로 변환)
      const rows = document.querySelectorAll('#monthlyTable tr');
      const csv = Array.from(rows).map(row => Array.from(row.cells).map(cell => cell.textContent.trim()).join(',')).join('\\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'monthly-sales.csv';
      link.click();
    }
  });

  // 상세 정보 패널 닫기
  document.getElementById('closeDetailBtn').addEventListener('click', () => {
    document.getElementById('detailSection').style.display = 'none';
  });
</script>
</body>
</html>
