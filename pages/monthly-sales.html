// 월별매출 현황 JavaScript (수정된 버전)

// 전역 변수
let salesData = [];
let currentDetailData = {};

// 안전한 요소 가져오기
function $(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`요소를 찾을 수 없습니다: ${id}`);
    }
    return element;
}

// 포맷팅 함수들 (CommonUtils 없이도 작동)
function formatNumber(number) {
    if (window.CommonUtils && CommonUtils.formatNumber) {
        return CommonUtils.formatNumber(number);
    }
    return new Intl.NumberFormat('ko-KR').format(number || 0);
}

function formatCurrency(amount) {
    if (window.CommonUtils && CommonUtils.formatCurrency) {
        return CommonUtils.formatCurrency(amount);
    }
    return new Intl.NumberFormat('ko-KR').format(amount || 0) + '원';
}

function formatDate(date) {
    if (window.CommonUtils && CommonUtils.formatDate) {
        return CommonUtils.formatDate(date);
    }
    if (!date || !(date instanceof Date)) return '-';
    return date.toLocaleDateString('ko-KR');
}

function getYearMonth(year, month) {
    if (window.CommonUtils && CommonUtils.getYearMonth) {
        return CommonUtils.getYearMonth(year, month);
    }
    return `${year}-${String(month).padStart(2, '0')}`;
}

function showAlert(message, type = 'info') {
    if (window.CommonUtils && CommonUtils.showAlert) {
        CommonUtils.showAlert(message, type);
    } else {
        console.log(`[${type.toUpperCase()}] ${message}`);
        if (type === 'error') {
            alert(`오류: ${message}`);
        } else if (type === 'success') {
            console.log(`✅ ${message}`);
        } else if (type === 'warning') {
            console.log(`⚠️ ${message}`);
        }
    }
}

// 샘플 데이터
const sampleData = [
    {
        date: '2024-01-15',
        type: '주문',
        contractName: '천보산 산림욕장 보완사업 관급자재',
        customer: '경기도 양주시',
        amount: 1500000,
        deliveryDate: '2024-01-25',
        invoiceDate: null,
        item: '식생매트' // 품목 추가
    },
    {
        date: '2024-01-20',
        type: '관급매출',
        contractName: '의정부시 녹지조성사업',
        customer: '의정부시',
        amount: 2800000,
        deliveryDate: null,
        invoiceDate: '2024-01-25',
        item: '고정핀'
    },
    {
        date: '2024-02-05',
        type: '주문',
        contractName: '서울시 한강공원 보행로 개선',
        customer: '서울시',
        amount: 3200000,
        deliveryDate: '2024-02-15',
        invoiceDate: null,
        item: '식생매트'
    },
    {
        date: '2024-02-10',
        type: '관급매출',
        contractName: '부천시 중앙공원 조성사업',
        customer: '부천시',
        amount: 4500000,
        deliveryDate: null,
        invoiceDate: '2024-02-15',
        item: '보행매트'
    },
    {
        date: '2024-03-12',
        type: '관급매출',
        contractName: '광주 북구 문화센터 주변 정비',
        customer: '광주 북구',
        amount: 5200000,
        deliveryDate: null,
        invoiceDate: '2024-03-15',
        item: '식생매트'
    },
    {
        date: '2024-04-07',
        type: '사급매출',
        contractName: '제주시 관광지 보행로 정비',
        customer: '제주시',
        amount: 3100000,
        deliveryDate: null,
        invoiceDate: '2024-04-10',
        item: '고정핀'
    }
];

// 날짜 파싱
function parseDate(dateStr) {
    if (!dateStr) return null;
    
    let date = new Date(dateStr);
    
    // 한국식 날짜 형식 처리 (MM/DD/YYYY)
    if (isNaN(date.getTime())) {
        // YYYY-MM-DD 형식 시도
        if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
            date = new Date(dateStr);
        }
        // MM/DD/YYYY 형식 시도
        else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
            const [month, day, year] = dateStr.split('/');
            date = new Date(year, month - 1, day);
        }
        // DD/MM/YYYY 형식 시도
        else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
            const parts = dateStr.split('/');
            // 첫 번째 숫자가 12보다 크면 DD/MM/YYYY로 판단
            if (parseInt(parts[0]) > 12) {
                const [day, month, year] = parts;
                date = new Date(year, month - 1, day);
            } else {
                const [month, day, year] = parts;
                date = new Date(year, month - 1, day);
            }
        }
    }
    
    return isNaN(date.getTime()) ? null : date;
}

// 실제 CSV 데이터 로드
async function loadSalesData() {
    try {
        console.log('CSV 데이터 로드 시작...');
        
        // 로딩 메시지 표시
        const tbody = $('monthlyTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">데이터를 불러오는 중...</td></tr>';
        }
        
        // sheets-api.js를 통한 데이터 로드
        let rawData;
        if (window.sheetsAPI) {
            rawData = await window.sheetsAPI.loadCSVData();
        } else {
            throw new Error('sheets-api.js가 로드되지 않았습니다.');
        }
        
        console.log(`${rawData.length}개의 원시 데이터 로드 완료`);
        
        if (rawData.length === 0) {
            throw new Error('파싱된 데이터가 없습니다.');
        }
        
        // 데이터 변환 및 정제
        salesData = rawData.map((item, index) => {
            try {
                // 다양한 필드명 지원
                const dateValue = item['주문일자'] || item['날짜'] || item['date'] || item['Date'] || item['계약일자'];
                const typeValue = item['구분'] || item['type'] || item['Type'] || item['분류']; // 구분 필드
                const contractValue = item['계약명'] || item['사업명'] || item['contractName'] || item['프로젝트명'] || '계약명 없음';
                const customerValue = item['거래처'] || item['수요기관'] || item['customer'] || item['고객명'] || '거래처 없음';
                const amountValue = item['합계'] || item['금액'] || item['amount'] || item['총액'] || '0';
                const invoiceDateValue = item['세금계산서'] || item['invoiceDate'] || item['발행일'] || item['세금계산서발행일'];
                
                // 품목 필드 추가 (G열) - 다양한 필드명 지원
                const itemValue = item['품목'] || item['제품'] || item['item'] || item['상품명'] || 
                                item['품목명'] || item['제품명'] || item['Item'] || item['Product'] || '';
                
                // 금액 파싱 (쉼표, 원화표시 제거)
                const cleanAmount = amountValue.toString().replace(/[^\d]/g, '');
                const parsedAmount = parseInt(cleanAmount) || 0;
                
                // 주문일자와 세금계산서 발행일자 파싱
                const orderDate = parseDate(dateValue);
                const invoiceDate = parseDate(invoiceDateValue);
                
                // 매출 구분이 있는 경우 처리
                let finalType = '';
                if (typeValue && (typeValue.includes('관급') || typeValue.includes('사급'))) {
                    if (typeValue.includes('관급')) {
                        finalType = '관급매출';
                    } else if (typeValue.includes('사급')) {
                        finalType = '사급매출';
                    }
                }
                
                const baseItem = {
                    contractName: contractValue.trim(),
                    customer: customerValue.trim(),
                    amount: parsedAmount,
                    orderDate: orderDate,
                    invoiceDate: invoiceDate,
                    item: itemValue.trim() || '' // 품목 추가 (빈 문자열 기본값)
                };
                
                // 결과 배열 (한 행에서 여러 타입 생성 가능)
                const results = [];
                
                // 1. 주문일자가 있으면 항상 데이터 생성
                if (orderDate) {
                    // 세금계산서 발행일자가 있으면 '납품완료', 없으면 '주문'
                    let orderStatus = '주문'; // 기본값
                    
                    if (invoiceDate) {
                        orderStatus = '납품완료';
                    }
                    
                    results.push({
                        ...baseItem,
                        date: orderDate,
                        type: orderStatus,
                        invoiceDate: invoiceDate
                    });
                }
                
                // 2. 매출 구분이 있고 세금계산서 발행일자가 있으면 매출 데이터 생성
                if (finalType && invoiceDate) {
                    results.push({
                        ...baseItem,
                        date: invoiceDate,
                        type: finalType,
                        invoiceDate: invoiceDate
                    });
                }
                
                return results;
            } catch (error) {
                console.warn(`데이터 변환 오류 (행 ${index + 1}):`, error);
                return [];
            }
        }).flat().filter(item => {
            // 유효한 데이터만 필터링
            return item && 
                   item.date instanceof Date && 
                   !isNaN(item.date.getTime()) && 
                   item.amount > 0 &&
                   item.contractName !== '계약명 없음' &&
                   item.customer !== '거래처 없음';
        });
        
        console.log(`${salesData.length}건의 유효한 데이터 변환 완료`);
        
        if (salesData.length === 0) {
            throw new Error('유효한 데이터가 없습니다.');
        }
        
        generateReport();
        showAlert(`${salesData.length}건의 데이터를 성공적으로 로드했습니다.`, 'success');
        
    } catch (error) {
        console.error('CSV 로드 실패:', error);
        showAlert(`데이터 로드 실패: ${error.message}`, 'error');
        loadSampleDataFallback();
    }
}

// 샘플 데이터로 대체
function loadSampleDataFallback() {
    console.log('샘플 데이터로 전환합니다.');
    
    salesData = sampleData.map(item => ({
        ...item,
        date: new Date(item.date),
        deliveryDate: item.deliveryDate ? new Date(item.deliveryDate) : null,
        invoiceDate: item.invoiceDate ? new Date(item.invoiceDate) : null
    }));
    
    generateReport();
    showAlert('샘플 데이터를 표시합니다. Google Sheets 연결을 확인해주세요.', 'warning');
}

// 보고서 생성
function generateReport() {
    try {
        const startYear = parseInt($('startYear')?.value || '2024');
        const startMonth = parseInt($('startMonth')?.value || '1');
        const endYear = parseInt($('endYear')?.value || '2024');
        const endMonth = parseInt($('endMonth')?.value || '12');
        
        const startDate = new Date(startYear, startMonth - 1, 1);
        const endDate = new Date(endYear, endMonth, 0);
        
        if (startDate > endDate) {
            showAlert('시작 기간이 종료 기간보다 늦을 수 없습니다.', 'warning');
            return;
        }
        
        const monthlyData = initializeMonthlyData(startDate, endDate);
        aggregateData(monthlyData, startDate, endDate);
        renderMonthlyTable(monthlyData);
        
    } catch (error) {
        console.error('보고서 생성 오류:', error);
        showAlert('보고서 생성 중 오류가 발생했습니다.', 'error');
    }
}

// 월별 데이터 초기화
function initializeMonthlyData(startDate, endDate) {
    const monthlyData = {};
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const yearMonth = getYearMonth(currentDate.getFullYear(), currentDate.getMonth() + 1);
        monthlyData[yearMonth] = {
            order: { count: 0, amount: 0, details: [] },
            government: { count: 0, amount: 0, details: [] },
            private: { count: 0, amount: 0, details: [] }
        };
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    
    return monthlyData;
}

// 데이터 집계 (수정된 로직)
function aggregateData(monthlyData, startDate, endDate) {
    // 계약명별 카운트 추적용 객체
    const contractCounts = {};
    
    salesData.forEach(item => {
        let targetDate = null;
        
        // 구분별 기준 날짜 설정
        switch (item.type) {
            case '주문':
            case '납품완료':
                // 주문/납품완료: 주문일자(orderDate) 기준
                targetDate = item.orderDate || item.date;
                break;
            case '관급매출':
            case '사급매출':
                // 매출: 세금계산서 발행일자(invoiceDate) 기준
                targetDate = item.invoiceDate || item.date;
                break;
            default:
                targetDate = item.date;
        }
        
        // 기준 날짜가 선택된 기간 내에 있는지 확인
        if (targetDate && targetDate >= startDate && targetDate <= endDate) {
            const yearMonth = getYearMonth(targetDate.getFullYear(), targetDate.getMonth() + 1);
            
            if (monthlyData[yearMonth]) {
                const contractKey = `${yearMonth}-${item.type}-${item.contractName}`;
                
                switch (item.type) {
                    case '주문':
                    case '납품완료':
                        // 계약명별 건수 카운트 (중복 제거)
                        if (!contractCounts[contractKey]) {
                            monthlyData[yearMonth].order.count++;
                            contractCounts[contractKey] = true;
                        }
                        monthlyData[yearMonth].order.amount += item.amount;
                        monthlyData[yearMonth].order.details.push({
                            ...item,
                            displayDate: targetDate // 표시용 날짜 (주문일자)
                        });
                        break;
                        
                    case '관급매출':
                        // 계약명별 건수 카운트 (중복 제거)
                        if (!contractCounts[contractKey]) {
                            monthlyData[yearMonth].government.count++;
                            contractCounts[contractKey] = true;
                        }
                        monthlyData[yearMonth].government.amount += item.amount;
                        monthlyData[yearMonth].government.details.push({
                            ...item,
                            displayDate: targetDate // 표시용 날짜 (세금계산서 발행일자)
                        });
                        break;
                        
                    case '사급매출':
                        // 계약명별 건수 카운트 (중복 제거)
                        if (!contractCounts[contractKey]) {
                            monthlyData[yearMonth].private.count++;
                            contractCounts[contractKey] = true;
                        }
                        monthlyData[yearMonth].private.amount += item.amount;
                        monthlyData[yearMonth].private.details.push({
                            ...item,
                            displayDate: targetDate // 표시용 날짜 (세금계산서 발행일자)
                        });
                        break;
                }
            }
        }
    });
    
    currentDetailData = monthlyData;
}

// 테이블 렌더링
function renderMonthlyTable(monthlyData) {
    const tbody = $('monthlyTableBody');
    if (!tbody) {
        console.error('monthlyTableBody 요소를 찾을 수 없습니다.');
        return;
    }
    
    tbody.innerHTML = '';
    
    let totals = {
        orderCount: 0, orderAmount: 0,
        govCount: 0, govAmount: 0,
        privCount: 0, privAmount: 0
    };
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    if (sortedMonths.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-8">해당 기간에 데이터가 없습니다.</td></tr>';
        updateTotalRow(totals);
        return;
    }
    
    sortedMonths.forEach(yearMonth => {
        const data = monthlyData[yearMonth];
        const [year, month] = yearMonth.split('-');
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        // 년/월
        const monthCell = document.createElement('td');
        monthCell.textContent = `${year}년 ${parseInt(month)}월`;
        monthCell.className = 'font-medium border-r border-gray-200';
        row.appendChild(monthCell);
        
        // 주문 건수
        const orderCountCell = document.createElement('td');
        orderCountCell.textContent = formatNumber(data.order.count);
        orderCountCell.className = 'text-center border-r border-gray-200';
        row.appendChild(orderCountCell);
        
        // 주문 금액
        const orderAmountCell = document.createElement('td');
        orderAmountCell.textContent = formatCurrency(data.order.amount);
        orderAmountCell.className = 'text-right border-r border-gray-200';
        if (data.order.amount > 0) {
            orderAmountCell.className += ' amount-clickable cursor-pointer text-blue-600 hover:text-blue-800';
            orderAmountCell.title = '클릭하여 상세내역 보기';
            orderAmountCell.addEventListener('click', () => showDetail(yearMonth, 'order', '주문'));
        }
        row.appendChild(orderAmountCell);
        
        // 관급매출 건수
        const govCountCell = document.createElement('td');
        govCountCell.textContent = formatNumber(data.government.count);
        govCountCell.className = 'text-center border-r border-gray-200';
        row.appendChild(govCountCell);
        
        // 관급매출 금액
        const govAmountCell = document.createElement('td');
        govAmountCell.textContent = formatCurrency(data.government.amount);
        govAmountCell.className = 'text-right border-r border-gray-200';
        if (data.government.amount > 0) {
            govAmountCell.className += ' amount-clickable cursor-pointer text-blue-600 hover:text-blue-800';
            govAmountCell.title = '클릭하여 상세내역 보기';
            govAmountCell.addEventListener('click', () => showDetail(yearMonth, 'government', '관급매출'));
        }
        row.appendChild(govAmountCell);
        
        // 사급매출 건수
        const privCountCell = document.createElement('td');
        privCountCell.textContent = formatNumber(data.private.count);
        privCountCell.className = 'text-center border-r border-gray-200';
        row.appendChild(privCountCell);
        
        // 사급매출 금액
        const privAmountCell = document.createElement('td');
        privAmountCell.textContent = formatCurrency(data.private.amount);
        privAmountCell.className = 'text-right border-r border-gray-200';
        if (data.private.amount > 0) {
            privAmountCell.className += ' amount-clickable cursor-pointer text-blue-600 hover:text-blue-800';
            privAmountCell.title = '클릭하여 상세내역 보기';
            privAmountCell.addEventListener('click', () => showDetail(yearMonth, 'private', '사급매출'));
        }
        row.appendChild(privAmountCell);
        
        // 합계 (관급매출 + 사급매출만, 주문 제외)
        const totalAmount = data.government.amount + data.private.amount;
        const totalCell = document.createElement('td');
        totalCell.textContent = formatCurrency(totalAmount);
        totalCell.className = 'text-right font-medium';
        row.appendChild(totalCell);
        
        tbody.appendChild(row);
        
        // 총계 누적
        totals.orderCount += data.order.count;
        totals.orderAmount += data.order.amount;
        totals.govCount += data.government.count;
        totals.govAmount += data.government.amount;
        totals.privCount += data.private.count;
        totals.privAmount += data.private.amount;
    });
    
    updateTotalRow(totals);
}

// 합계 행 업데이트
function updateTotalRow(totals) {
    const elements = {
        totalOrderCount: $('totalOrderCount'),
        totalOrderAmount: $('totalOrderAmount'),
        totalGovCount: $('totalGovCount'),
        totalGovAmount: $('totalGovAmount'),
        totalPrivCount: $('totalPrivCount'),
        totalPrivAmount: $('totalPrivAmount'),
        grandTotal: $('grandTotal')
    };
    
    if (elements.totalOrderCount) elements.totalOrderCount.textContent = formatNumber(totals.orderCount);
    if (elements.totalOrderAmount) elements.totalOrderAmount.textContent = formatCurrency(totals.orderAmount);
    if (elements.totalGovCount) elements.totalGovCount.textContent = formatNumber(totals.govCount);
    if (elements.totalGovAmount) elements.totalGovAmount.textContent = formatCurrency(totals.govAmount);
    if (elements.totalPrivCount) elements.totalPrivCount.textContent = formatNumber(totals.privCount);
    if (elements.totalPrivAmount) elements.totalPrivAmount.textContent = formatCurrency(totals.privAmount);
    
    const grandTotal = totals.govAmount + totals.privAmount; // 주문 제외
    if (elements.grandTotal) elements.grandTotal.textContent = formatCurrency(grandTotal);
}

// 상세 내역 표시
function showDetail(yearMonth, type, typeName) {
    const [year, month] = yearMonth.split('-');
    const monthName = `${year}년 ${parseInt(month)}월`;
    
    const details = currentDetailData[yearMonth][type].details;
    
    if (!details || details.length === 0) {
        showAlert('해당 월에 데이터가 없습니다.', 'info');
        return;
    }
    
    const detailTitle = $('detailTitle');
    if (detailTitle) {
        detailTitle.textContent = `${monthName} ${typeName} 상세 내역 (${details.length}건)`;
    }
    
    // 테이블 헤더 업데이트
    updateDetailTableHeader(type);
    
    renderDetailTable(details, type);
    
    const detailSection = $('detailSection');
    if (detailSection) {
        detailSection.classList.remove('hidden');
        detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // X 버튼 이벤트 리스너 추가
    const closeBtn = $('closeDetailBtn');
    if (closeBtn) {
        closeBtn.onclick = hideDetailSection;
    }
}

// 상세 테이블 헤더 업데이트
function updateDetailTableHeader(type) {
    const headerRow = $('detailTableHeader');
    if (!headerRow) {
        // 기존 헤더가 없으면 thead에서 tr 찾기
        const thead = document.querySelector('#detailTable thead');
        const existingHeader = thead ? thead.querySelector('tr') : null;
        if (existingHeader) {
            existingHeader.id = 'detailTableHeader';
            updateHeaderContent(existingHeader, type);
        }
        return;
    }
    
    updateHeaderContent(headerRow, type);
}

// 헤더 내용 업데이트
function updateHeaderContent(headerRow, type) {
    headerRow.innerHTML = '';
    
    if (type === 'order') {
        // 주문 상세내역: 상태, 계약명, 거래처, 금액, 날짜, 품목
        headerRow.innerHTML = `
            <th>상태</th>
            <th>계약명</th>
            <th>거래처</th>
            <th>금액</th>
            <th>날짜</th>
            <th>품목</th>
        `;
    } else {
        // 관급/사급 매출 상세내역: 계약명, 거래처, 금액, 날짜, 품목
        headerRow.innerHTML = `
            <th>계약명</th>
            <th>거래처</th>
            <th>금액</th>
            <th>날짜</th>
            <th>품목</th>
        `;
    }
}

// 상세내역 섹션 숨기기
function hideDetailSection() {
    const detailSection = $('detailSection');
    if (detailSection) {
        detailSection.classList.add('hidden');
    }
}

// 상세 테이블 렌더링 (수정된 버전 - 품목 + 등 표시)
function renderDetailTable(details, type) {
    const tbody = $('detailTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // 계약명별로 데이터 합치기 및 품목 처리
    const mergedData = {};
    details.forEach(item => {
        const key = `${item.contractName}-${item.customer}`;
        if (mergedData[key]) {
            // 기존 항목에 금액 합산 및 품목 비교
            mergedData[key].amount += item.amount;
            // 더 큰 금액을 가진 품목으로 업데이트
            if (item.amount > mergedData[key].maxAmount) {
                mergedData[key].mainItem = item.item || '';
                mergedData[key].maxAmount = item.amount;
            }
            mergedData[key].hasMultipleItems = true;
        } else {
            // 새 항목 추가
            mergedData[key] = {
                contractName: item.contractName,
                customer: item.customer,
                amount: item.amount,
                type: item.type,
                displayDate: item.displayDate || item.invoiceDate || item.date,
                mainItem: item.item || '',
                maxAmount: item.amount,
                hasMultipleItems: false
            };
        }
    });
    
    // 합쳐진 데이터를 배열로 변환하고 금액순 정렬
    const sortedData = Object.values(mergedData).sort((a, b) => b.amount - a.amount);
    
    sortedData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        // 주문 상세내역인 경우 '상태' 컬럼을 계약명 앞에 추가
        if (type === 'order') {
            // 상태 (주문/납품완료)
            const statusCell = document.createElement('td');
            let badgeClass = item.type === '주문' ? 'badge-primary' : 'badge-success';
            statusCell.innerHTML = `<span class="badge ${badgeClass}">${item.type}</span>`;
            statusCell.className = 'text-center';
            row.appendChild(statusCell);
        }
        
        // 계약명
        const contractCell = document.createElement('td');
        contractCell.textContent = item.contractName;
        contractCell.className = 'font-medium';
        row.appendChild(contractCell);
        
        // 거래처
        const customerCell = document.createElement('td');
        customerCell.textContent = item.customer;
        row.appendChild(customerCell);
        
        // 금액
        const amountCell = document.createElement('td');
        amountCell.textContent = formatCurrency(item.amount);
        amountCell.className = 'text-right font-medium amount';
        row.appendChild(amountCell);
        
        // 날짜
        const dateCell = document.createElement('td');
        let dateText = '';
        if (type === 'order') {
            // 주문: 주문일자 표시
            dateText = item.displayDate ? formatDate(item.displayDate) : '-';
        } else {
            // 관급매출, 사급매출: 세금계산서 발행일자 표시
            dateText = item.displayDate ? formatDate(item.displayDate) : '-';
        }
        dateCell.textContent = dateText;
        dateCell.className = 'text-center';
        row.appendChild(dateCell);
        
        // 품목 (수정된 부분)
        const itemCell = document.createElement('td');
        let itemText = item.mainItem || '-';
        if (item.hasMultipleItems && item.mainItem) {
            itemText += ' 등';
        }
        itemCell.textContent = itemText;
        itemCell.className = 'text-center';
        row.appendChild(itemCell);
        
        tbody.appendChild(row);
    });
}

// 인쇄 기능 추가
function printReport() {
    const printWindow = window.open('', '_blank');
    const currentDate = new Date().toLocaleDateString('ko-KR');
    
    // 현재 선택된 기간 정보
    const startYear = $('startYear')?.value || '2025';  
    const startMonth = $('startMonth')?.value || '1';
    const endYear = $('endYear')?.value || '2025';
    const endMonth = $('endMonth')?.value || '12';
    
    const periodText = `${startYear}년 ${startMonth}월 ~ ${endYear}년 ${endMonth}월`;
    
    // 월별 테이블 HTML 복사
    const monthlyTable = document.getElementById('monthlyTable');
    const monthlyTableHTML = monthlyTable ? monthlyTable.outerHTML : '<p>테이블 데이터가 없습니다.</p>';
    
    // 상세 테이블 HTML (있는 경우)
    const detailSection = document.getElementById('detailSection');
    const hasDetailData = detailSection && !detailSection.classList.contains('hidden');
    const detailHTML = hasDetailData ? `
        <div style="page-break-before: always;">
            <h2 style="color: #374151; margin-bottom: 1rem;">${document.getElementById('detailTitle')?.textContent || '상세 내역'}</h2>
            ${document.getElementById('detailTable')?.outerHTML || ''}
        </div>
    ` : '';
    
    const printHTML = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>월별매출 현황 - ${periodText}</title>
            <style>
                @page {
                    size: A4;
                    margin: 20mm;
                }
                
                * {
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
                    font-size: 12px;
                    line-height: 1.4;
                    color: #333;
                    margin: 0;
                    padding: 0;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 15px;
                }
                
                .header h1 {
                    margin: 0;
                    font-size: 24px;
                    color: #333;
                }
                
                .header .period {
                    margin: 5px 0;
                    font-size: 16px;
                    color: #666;
                }
                
                .header .print-date {
                    margin: 0;
                    font-size: 12px;
                    color: #999;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                    font-size: 11px;
                }
                
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: center;
                    vertical-align: middle;
                }
                
                th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                    color: #333;
                }
                
                .text-right {
                    text-align: right;
                }
                
                .font-medium {
                    font-weight: 600;
                }
                
                .font-bold {
                    font-weight: bold;
                }
                
                .amount {
                    color: #059669;
                    font-weight: 600;
                }
                
                .bg-gray-100 {
                    background-color: #f3f4f6;
                }
                
                .badge {
                    display: inline-block;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: 500;
                }
                
                .badge-primary {
                    background-color: #dbeafe;
                    color: #1e40af;
                }
                
                .badge-success {
                    background-color: #d1fae5;
                    color: #065f46;
                }
                
                .badge-warning {
                    background-color: #fef3c7;
                    color: #92400e;
                }
                
                .no-print {
                    display: none;
                }
                
                @media print {
                    body { 
                        font-size: 11px; 
                    }
                    
                    table { 
                        font-size: 10px; 
                    }
                    
                    th, td { 
                        padding: 6px; 
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>월별매출 현황</h1>
                <p class="period">기간: ${periodText}</p>
                <p class="print-date">출력일: ${currentDate}</p>
            </div>
            
            <div class="content">
                ${monthlyTableHTML}
                ${detailHTML}
            </div>
            
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                    }, 500);
                    
                    window.onafterprint = function() {
                        window.close();
                    };
                };
            </script>
        </body>
        </html>
    `;
    
    printWindow.document.write(printHTML);
    printWindow.document.close();
}

// 데이터 새로고침
async function refreshData() {
    try {
        const refreshBtn = $('refreshBtn');
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '새로고침 중...';
        }
        
        // 캐시 강제 새로고침
        if (window.sheetsAPI) {
            await window.sheetsAPI.refreshCache();
        }
        
        await loadSalesData();
        
        showAlert('데이터가 새로고침되었습니다.', 'success');
        
    } catch (error) {
        console.error('데이터 새로고침 실패:', error);
        showAlert('데이터 새로고침에 실패했습니다.', 'error');
        
    } finally {
        const refreshBtn = $('refreshBtn');
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = '새로고침';
        }
    }
}

// 연결 상태 확인
async function checkConnection() {
    try {
        if (window.sheetsAPI) {
            const isConnected = await window.sheetsAPI.testConnection();
            const message = isConnected ? 
                'Google Sheets 연결이 정상입니다.' : 
                'Google Sheets 연결에 문제가 있습니다.';
            const type = isConnected ? 'success' : 'warning';
            showAlert(message, type);
        } else {
            showAlert('sheets-api.js가 로드되지 않았습니다.', 'error');
        }
    } catch (error) {
        console.error('연결 확인 실패:', error);
        showAlert('연결 확인 중 오류가 발생했습니다.', 'error');
    }
}

// 전역 함수들
window.loadSampleData = loadSalesData;  // HTML에서 호출하는 함수
window.generateReport = generateReport;
window.showDetail = showDetail;
window.refreshData = refreshData;
window.checkConnection = checkConnection;
window.printReport = printReport;  // 인쇄 기능 추가
window.hideDetailSection = hideDetailSection;  // X 버튼 기능 추가

// 페이지 로드시 자동 실행
document.addEventListener('DOMContentLoaded', function() {
    console.log('페이지 로드 완료, 데이터 로딩 시작...');
    
    // sheets-api.js 로드 확인
    if (window.sheetsAPI) {
        console.log('sheets-api.js 로드 확인됨');
        setTimeout(loadSalesData, 100); // 약간의 지연 후 실행
    } else {
        console.warn('sheets-api.js가 로드되지 않음, 재시도...');
        // 최대 3초간 재시도
        let retryCount = 0;
        const retryInterval = setInterval(() => {
            if (window.sheetsAPI || retryCount >= 30) {
                clearInterval(retryInterval);
                if (window.sheetsAPI) {
                    console.log('sheets-api.js 지연 로드 확인됨');
                    loadSalesData();
                } else {
                    console.error('sheets-api.js 로드 실패, 샘플 데이터 사용');
                    loadSampleDataFallback();
                }
            }
            retryCount++;
        }, 100);
    }
});
