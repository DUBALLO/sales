<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수요기관 구매내역 - 판매실적 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../assets/css/common.css" rel="stylesheet">
    <link href="../assets/css/customer-analysis.css" rel="stylesheet">
    <script src="../assets/js/sheets-api.js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="text-lg font-semibold text-gray-900">판매실적 대시보드</a>
                    <span class="text-gray-400">|</span>
                    <span class="text-green-600 font-medium">수요기관 구매내역</span>
                </div>
                <div class="flex space-x-2">
                    <a href="../index.html" class="nav-link">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        홈
                    </a>
                    <a href="./monthly-sales.html" class="nav-link">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        월별매출 현황
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">수요기관 구매내역</h1>
            <p class="text-gray-600">특정 수요기관의 구매 내역과 거래 업체, 품목별 분석 데이터를 확인할 수 있습니다.</p>
        </div>

        <div id="connectionStatus" class="mb-4 p-3 rounded-lg border hidden">
            <div class="flex items-center">
                <div id="statusIcon" class="w-3 h-3 rounded-full mr-2"></div>
                <span id="statusText" class="text-sm font-medium"></span>
            </div>
        </div>

        <div class="filter-section bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-wrap items-end gap-4 mb-4">
                <div class="flex-1">
                    <label class="form-label">수요기관 검색</label>
                    <div class="search-box relative">
                        <input type="text" id="searchInput" class="form-input search-input" placeholder="수요기관명으로 검색...">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <label class="form-label">분석 기간</label>
                    <select id="analysisYear" class="form-select">
                        <option value="2020">2020년</option>
                        <option value="2021">2021년</option>
                        <option value="2022">2022년</option>
                        <option value="2023">2023년</option>
                        <option value="2024">2024년</option>
                        <option value="2025" selected>2025년</option>
                        <option value="all">전체</option>
                    </select>
                </div>
                
                <button id="analyzeBtn" class="btn btn-success">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    분석
                </button>
                
                <button id="refreshBtn" class="btn btn-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    새로고침
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 stats-grid">
            <div id="totalSuppliersCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 업체 수</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSuppliers">로딩중...</p>
                    </div>
                </div>
            </div>

            <div id="totalContractsCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                         <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 구매 건수</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalContracts">로딩중...</p>
                    </div>
                </div>
            </div>

            <div id="totalSalesCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 구매액</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSales">로딩중...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button id="supplierTab" class="analysis-tab active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        업체별 구매 순위
                    </button>
                    <button id="productTab" class="analysis-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        품목별 분석
                    </button>
                    <button id="regionTab" class="analysis-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        지역별 분석
                    </button>
                </nav>
            </div>

            <div id="supplierPanel" class="tab-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">업체별 구매 순위</h3>
                    <button id="exportSupplierBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="supplierTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 1)">업체명</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 2, 'number')">계약건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 3, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="productPanel" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">품목별 분석</h3>
                    <button id="exportProductBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="productTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 1)">품목명</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 2, 'number')">구매 건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 3, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="regionPanel" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">지역별 분석</h3>
                    <button id="exportRegionBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="regionTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 1)">지역</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 2, 'number')">업체 수</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 3, 'number')">구매 건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 4, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="regionTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/agency-purchase-history.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('수요기관 구매내역 페이지 로드 완료');
            
            // 탭 전환 이벤트
            const tabs = ['supplier', 'product', 'region'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(tab + 'Tab');
                if (tabBtn) {
                    tabBtn.addEventListener('click', () => showTab(tab));
                }
            });
            
            // 분석 버튼 이벤트
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn && window.AgencyAnalysis) {
                analyzeBtn.addEventListener('click', window.AgencyAnalysis.analyzeData);
            }
            
            // 새로고침 버튼 이벤트
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn && window.sheetsAPI) {
                refreshBtn.addEventListener('click', async () => {
                    try {
                        await window.sheetsAPI.refreshCache();
                        if (window.AgencyAnalysis) {
                            window.AgencyAnalysis.analyzeData();
                        }
                    } catch (error) {
                        console.error('새로고침 실패:', error);
                    }
                });
            }
            
            // 검색 이벤트
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
            
            // 내보내기 이벤트
            document.getElementById('exportSupplierBtn')?.addEventListener('click', () => 
                exportTable('supplierTable', '업체별_구매순위.csv'));
            document.getElementById('exportProductBtn')?.addEventListener('click', () => 
                exportTable('productTable', '품목별_분석.csv'));
            document.getElementById('exportRegionBtn')?.addEventListener('click', () => 
                exportTable('regionTable', '지역별_분석.csv'));
            
            // 초기 데이터 로드 시도
            if (window.AgencyAnalysis) {
                console.log('수요기관 분석 모듈 확인됨, 초기 분석 시작');
                window.AgencyAnalysis.analyzeData();
            } else {
                console.warn('AgencyAnalysis 모듈이 로드되지 않음');
                const checkInterval = setInterval(() => {
                    if (window.AgencyAnalysis) {
                        clearInterval(checkInterval);
                        console.log('AgencyAnalysis 모듈 로드 확인, 분석 시작');
                        window.AgencyAnalysis.analyzeData();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.error('AgencyAnalysis 모듈 로드 실패');
                }, 5000);
            }
        });
        
        // 탭 전환 함수
        function showTab(tabName) {
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            document.getElementById(tabName + 'Panel').classList.remove('hidden');
        }
        
        // 검색 함수
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activePanel = document.querySelector('.tab-panel:not(.hidden)');
            const table = activePanel?.querySelector('table tbody');
            
            if (table) {
                Array.from(table.querySelectorAll('tr')).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }
        }
        
        // CSV 내보내기 함수
        function exportTable(tableId, filename) {
            if (window.CommonUtils && CommonUtils.exportTableToCSV) {
                const table = document.getElementById(tableId);
                CommonUtils.exportTableToCSV(table, filename);
            } else {
                alert('내보내기 기능을 사용할 수 없습니다.');
            }
        }
    </script>
</body>
</html>
네, 알겠습니다. **`수요기관 구매내역`** 보드 개발을 시작해 보겠습니다.

고객님께서 주신 `customer-analysis.html`과 `customer-analysis.js` 코드를 기반으로 새로운 파일을 만들고, 새로운 보드에 맞게 기능을 수정하겠습니다.

먼저, `수요기관 구매내역` 보드의 HTML 파일인 **`agency-purchase-history.html`**의 코드를 제공해 드릴게요. 이 코드를 복사해서 `agency-purchase-history.html` 파일을 새로 만들어 주세요.

---
### `agency-purchase-history.html` 파일

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수요기관 구매내역 - 판매실적 대시보드</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="../assets/css/common.css" rel="stylesheet">
    <link href="../assets/css/customer-analysis.css" rel="stylesheet">
    <script src="../assets/js/sheets-api.js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="text-lg font-semibold text-gray-900">판매실적 대시보드</a>
                    <span class="text-gray-400">|</span>
                    <span class="text-green-600 font-medium">수요기관 구매내역</span>
                </div>
                <div class="flex space-x-2">
                    <a href="../index.html" class="nav-link">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        홈
                    </a>
                    <a href="./monthly-sales.html" class="nav-link">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        월별매출 현황
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">수요기관 구매내역</h1>
            <p class="text-gray-600">특정 수요기관의 구매 내역과 거래 업체, 품목별 분석 데이터를 확인할 수 있습니다.</p>
        </div>

        <div id="connectionStatus" class="mb-4 p-3 rounded-lg border hidden">
            <div class="flex items-center">
                <div id="statusIcon" class="w-3 h-3 rounded-full mr-2"></div>
                <span id="statusText" class="text-sm font-medium"></span>
            </div>
        </div>

        <div class="filter-section bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-wrap items-end gap-4 mb-4">
                <div class="flex-1">
                    <label class="form-label">수요기관 검색</label>
                    <div class="search-box relative">
                        <input type="text" id="searchInput" class="form-input search-input" placeholder="수요기관명으로 검색...">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <label class="form-label">분석 기간</label>
                    <select id="analysisYear" class="form-select">
                        <option value="2020">2020년</option>
                        <option value="2021">2021년</option>
                        <option value="2022">2022년</option>
                        <option value="2023">2023년</option>
                        <option value="2024">2024년</option>
                        <option value="2025" selected>2025년</option>
                        <option value="all">전체</option>
                    </select>
                </div>
                
                <button id="analyzeBtn" class="btn btn-success">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    분석
                </button>
                
                <button id="refreshBtn" class="btn btn-secondary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    새로고침
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 stats-grid">
            <div id="totalSuppliersCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 업체 수</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSuppliers">로딩중...</p>
                    </div>
                </div>
            </div>

            <div id="totalContractsCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                         <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 구매 건수</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalContracts">로딩중...</p>
                    </div>
                </div>
            </div>

            <div id="totalSalesCard" class="bg-white rounded-lg shadow-md p-6 stats-card">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">총 구매액</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSales">로딩중...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button id="supplierTab" class="analysis-tab active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        업체별 구매 순위
                    </button>
                    <button id="productTab" class="analysis-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        품목별 분석
                    </button>
                    <button id="regionTab" class="analysis-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        지역별 분석
                    </button>
                </nav>
            </div>

            <div id="supplierPanel" class="tab-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">업체별 구매 순위</h3>
                    <button id="exportSupplierBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="supplierTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 1)">업체명</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 2, 'number')">계약건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('supplierTableBody', 3, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="supplierTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="productPanel" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">품목별 분석</h3>
                    <button id="exportProductBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="productTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 1)">품목명</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 2, 'number')">구매 건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('productTableBody', 3, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="regionPanel" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">지역별 분석</h3>
                    <button id="exportRegionBtn" class="btn btn-secondary btn-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        CSV 내보내기
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="regionTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 0, 'number')">순위</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 1)">지역</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 2, 'number')">업체 수</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 3, 'number')">구매 건수</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="window.AgencyAnalysis.sortTable('regionTableBody', 4, 'number')">총 구매액</th>
                            </tr>
                        </thead>
                        <tbody id="regionTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center py-8 text-gray-500">분석 버튼을 클릭하여 데이터를 로드하세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/agency-purchase-history.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('수요기관 구매내역 페이지 로드 완료');
            
            // 탭 전환 이벤트
            const tabs = ['supplier', 'product', 'region'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(tab + 'Tab');
                if (tabBtn) {
                    tabBtn.addEventListener('click', () => showTab(tab));
                }
            });
            
            // 분석 버튼 이벤트
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn && window.AgencyAnalysis) {
                analyzeBtn.addEventListener('click', window.AgencyAnalysis.analyzeData);
            }
            
            // 새로고침 버튼 이벤트
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn && window.sheetsAPI) {
                refreshBtn.addEventListener('click', async () => {
                    try {
                        await window.sheetsAPI.refreshCache();
                        if (window.AgencyAnalysis) {
                            window.AgencyAnalysis.analyzeData();
                        }
                    } catch (error) {
                        console.error('새로고침 실패:', error);
                    }
                });
            }
            
            // 검색 이벤트
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
            
            // 내보내기 이벤트
            document.getElementById('exportSupplierBtn')?.addEventListener('click', () => 
                exportTable('supplierTable', '업체별_구매순위.csv'));
            document.getElementById('exportProductBtn')?.addEventListener('click', () => 
                exportTable('productTable', '품목별_분석.csv'));
            document.getElementById('exportRegionBtn')?.addEventListener('click', () => 
                exportTable('regionTable', '지역별_분석.csv'));
            
            // 초기 데이터 로드 시도
            if (window.AgencyAnalysis) {
                console.log('수요기관 분석 모듈 확인됨, 초기 분석 시작');
                window.AgencyAnalysis.analyzeData();
            } else {
                console.warn('AgencyAnalysis 모듈이 로드되지 않음');
                const checkInterval = setInterval(() => {
                    if (window.AgencyAnalysis) {
                        clearInterval(checkInterval);
                        console.log('AgencyAnalysis 모듈 로드 확인, 분석 시작');
                        window.AgencyAnalysis.analyzeData();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.error('AgencyAnalysis 모듈 로드 실패');
                }, 5000);
            }
        });
        
        // 탭 전환 함수
        function showTab(tabName) {
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            document.getElementById(tabName + 'Panel').classList.remove('hidden');
        }
        
        // 검색 함수
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activePanel = document.querySelector('.tab-panel:not(.hidden)');
            const table = activePanel?.querySelector('table tbody');
            
            if (table) {
                Array.from(table.querySelectorAll('tr')).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }
        }
        
        // CSV 내보내기 함수
        function exportTable(tableId, filename) {
            if (window.CommonUtils && CommonUtils.exportTableToCSV) {
                const table = document.getElementById(tableId);
                CommonUtils.exportTableToCSV(table, filename);
            } else {
                alert('내보내기 기능을 사용할 수 없습니다.');
            }
        }
    </script>
</body>
</html>

---

이제 이 보드의 기능을 담당하는 JavaScript 파일인 **`agency-purchase-history.js`**의 코드를 제공해 드릴게요. 기존 `customer-analysis.js`의 코드를 바탕으로 수정했습니다. 이 코드를 복사해서 `agency-purchase-history.js` 파일을 새로 만들어 주세요.

---
### `agency-purchase-history.js` 파일

```javascript
// 수요기관 구매내역 분석 JavaScript

// 전역 변수
let purchaseData = [];
let supplierData = [];
let productData = [];
let regionData = [];
let isLoading = false;

// 안전한 요소 가져오기
function $(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`요소를 찾을 수 없습니다: ${id}`);
    }
    return element;
}

// 포맷팅 함수들
function formatCurrency(amount) {
    if (!amount && amount !== 0) return '-';
    return new Intl.NumberFormat('ko-KR').format(amount) + '원';
}

function formatNumber(number) {
    if (!number && number !== 0) return '-';
    return new Intl.NumberFormat('ko-KR').format(number);
}

// 날짜 파싱 함수
function parseDate(dateStr) {
    if (!dateStr) return null;
    
    let date = new Date(dateStr);
    
    if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
            date = new Date(dateStr);
        } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
            const [month, day, year] = dateStr.split('/');
            date = new Date(year, month - 1, day);
        }
    }
    
    return isNaN(date.getTime()) ? null : date;
}

// 금액 파싱 함수
function parseAmount(amountStr) {
    if (!amountStr) return 0;
    const cleanAmount = amountStr.toString().replace(/[^\d]/g, '');
    return parseInt(cleanAmount) || 0;
}

// 메인 분석 함수
async function analyzeData() {
    try {
        console.log('=== 수요기관 구매내역 분석 시작 ===');
        
        showLoadingState(true);
        
        let useRealData = false;
        
        if (window.sheetsAPI) {
            try {
                console.log('sheets-api를 통한 실제 데이터 로드 시도...');
                const rawData = await window.sheetsAPI.loadCSVData('procurement');
                
                if (rawData && rawData.length > 0) {
                    console.log('sheets-api에서 로드된 원시 데이터:', rawData.length, '건');
                    parseRealData(rawData);
                    useRealData = true;
                } else {
                    throw new Error('로드된 데이터가 비어있습니다.');
                }
                
            } catch (error) {
                console.warn('실제 데이터 로드 실패:', error.message);
                useRealData = false;
            }
        } else {
            console.warn('sheets-api.js가 로드되지 않음');
            useRealData = false;
        }
        
        if (!useRealData) {
            console.log('샘플 데이터 사용');
            generateSampleData();
        }
        
        const selectedYear = $('analysisYear')?.value || 'all';
        const searchTerm = $('searchInput')?.value?.toLowerCase() || '';
        
        console.log('분석 조건 - 연도:', selectedYear, '검색어:', searchTerm);
        
        let filteredData = [...purchaseData];
        
        if (selectedYear !== 'all') {
            const year = parseInt(selectedYear);
            filteredData = filteredData.filter(item => {
                const date = parseDate(item.purchaseDate || '');
                return date && date.getFullYear() === year;
            });
        }
        
        if (searchTerm) {
            filteredData = filteredData.filter(item => 
                (item.agency || '').toLowerCase().includes(searchTerm)
            );
        }
        
        analyzeSupplierData(filteredData);
        analyzeProductData(filteredData);
        analyzeRegionData(filteredData);

        updateSummaryStats(filteredData);
        renderAllTables();
        
        console.log('=== 수요기관 구매내역 분석 완료 ===');
        
        const message = useRealData ? 
            `실제 데이터 분석 완료 (${purchaseData.length}건)` :
            '샘플 데이터로 분석 완료';
        showAlert(message, useRealData ? 'success' : 'warning');
        
    } catch (error) {
        console.error('분석 오류:', error);
        showAlert('분석 중 오류가 발생했습니다: ' + error.message, 'error');
    } finally {
        showLoadingState(false);
    }
}

// 실제 데이터 파싱 함수 (컬럼명 교정)
function parseRealData(rawData) {
    console.log('=== 실제 데이터 파싱 시작 ===');
    
    purchaseData = [];
    
    rawData.forEach(item => {
        try {
            const baseData = {
                agency: (item['수요기관명'] || '').trim(),
                supplier: (item['업체'] || '').trim(),
                region: (item['수요기관지역'] || '').trim(),
                product: (item['세부품명'] || '').trim(),
                amount: parseAmount(item['공급금액'] || '0'),
                purchaseDate: item['기준일자'] || '',
                contractName: (item['계약명'] || '').trim()
            };
            
            if (!baseData.agency || baseData.agency === '수요기관명 없음' || baseData.amount <= 0) return;
            
            purchaseData.push(baseData);
            
        } catch (error) {
            console.warn(`데이터 파싱 오류 (행):`, error.message);
        }
    });
    
    console.log('데이터 파싱 완료');
    console.log(`유효한 데이터: ${purchaseData.length}건`);
}

// 샘플 데이터 생성
function generateSampleData() {
    console.log('=== 샘플 데이터 생성 시작 ===');
    
    purchaseData = [
        {
            agency: '경기도 양주시', supplier: '두발로 주식회사', region: '경기도', product: '보행매트',
            amount: 15000000, purchaseDate: '2024-01-15', contractName: '천보산 산림욕장 보완사업'
        },
        {
            agency: '의정부시', supplier: '두발로 주식회사', region: '경기도', product: '보행매트',
            amount: 28000000, purchaseDate: '2024-02-10', contractName: '의정부시 녹지조성사업'
        },
        {
            agency: '서울시 한강사업본부', supplier: '한솔기술', region: '서울특별시', product: '식생매트',
            amount: 32000000, purchaseDate: '2024-02-05', contractName: '서울시 한강공원 보행로 개선'
        },
        {
            agency: '부천시청', supplier: '두발로 주식회사', region: '경기도', product: '논슬립',
            amount: 45000000, purchaseDate: '2024-03-12', contractName: '부천시 중앙공원 조성사업'
        },
        {
            agency: '춘천시 공원과', supplier: '산하건설', region: '강원도', product: '보행매트',
            amount: 22000000, purchaseDate: '2024-03-20', contractName: '춘천시 공원 조성사업'
        }
    ];
    
    console.log('샘플 데이터 생성 완료');
}

// 업체별 데이터 분석
function analyzeSupplierData(data) {
    console.log('=== 업체별 데이터 분석 ===');
    const supplierMap = new Map();
    data.forEach(item => {
        const supplier = item.supplier || '';
        if (!supplierMap.has(supplier)) {
            supplierMap.set(supplier, {
                supplier: supplier,
                contracts: new Set(),
                amount: 0
            });
        }
        
        const supplierInfo = supplierMap.get(supplier);
        supplierInfo.contracts.add(item.contractName);
        supplierInfo.amount += item.amount || 0;
    });
    
    supplierData = Array.from(supplierMap.values()).map(item => ({
        ...item,
        contractCount: item.contracts.size
    }));
    
    supplierData.sort((a, b) => b.amount - a.amount);
    
    supplierData.forEach((item, index) => { item.rank = index + 1; });
    
    console.log(`업체별 분석 완료: ${supplierData.length}개 업체`);
}

// 품목별 데이터 분석
function analyzeProductData(data) {
    const productMap = new Map();
    data.forEach(item => {
        const product = item.product || '';
        if (!productMap.has(product)) {
            productMap.set(product, {
                product: product,
                contracts: new Set(),
                amount: 0
            });
        }
        const productInfo = productMap.get(product);
        productInfo.contracts.add(item.contractName);
        productInfo.amount += item.amount || 0;
    });
    
    productData = Array.from(productMap.values()).map(item => ({
        ...item,
        contractCount: item.contracts.size
    }));
    productData.sort((a, b) => b.amount - a.amount);
    
    productData.forEach((item, index) => { item.rank = index + 1; });
}

// 지역별 데이터 분석
function analyzeRegionData(data) {
    const regionMap = new Map();
    data.forEach(item => {
        const region = item.region || '';
        if (!regionMap.has(region)) {
            regionMap.set(region, {
                region: region,
                supplierCount: new Set(),
                contractCount: 0,
                amount: 0
            });
        }
        const regionInfo = regionMap.get(region);
        regionInfo.supplierCount.add(item.supplier);
        regionInfo.contractCount++;
        regionInfo.amount += item.amount || 0;
    });
    
    regionData = Array.from(regionMap.values()).map(item => ({
        ...item,
        supplierCount: item.supplierCount.size
    }));
    regionData.sort((a, b) => b.amount - a.amount);
    
    regionData.forEach((item, index) => { item.rank = index + 1; });
}

// 요약 통계 업데이트
function updateSummaryStats(data) {
    const totalSuppliers = new Set(data.map(item => item.supplier)).size;
    const totalContracts = new Set(data.map(item => item.contractName)).size;
    const totalAmount = data.reduce((sum, item) => sum + (item.amount || 0), 0);
    
    const elements = {
        totalSuppliers: $('totalSuppliers'),
        totalContracts: $('totalContracts'),
        totalSales: $('totalSales')
    };
    
    if (elements.totalSuppliers) elements.totalSuppliers.textContent = formatNumber(totalSuppliers) + '개';
    if (elements.totalContracts) elements.totalContracts.textContent = formatNumber(totalContracts) + '건';
    if (elements.totalSales) elements.totalSales.textContent = formatCurrency(totalAmount);
}

// 모든 테이블 렌더링
function renderAllTables() {
    renderSupplierTable();
    renderProductTable();
    renderRegionTable();
}

// 업체별 테이블 렌더링
function renderSupplierTable() {
    const tbody = $('supplierTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const dataToRender = [...supplierData];
    
    if (dataToRender.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">업체 데이터가 없습니다.</td></tr>';
        return;
    }
    
    dataToRender.forEach((supplier, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        row.innerHTML = `
            <td class="text-center font-medium">${supplier.rank}</td>
            <td class="font-medium">${supplier.supplier}</td>
            <td class="text-center">${formatNumber(supplier.contractCount)}</td>
            <td class="text-right font-medium amount">${formatCurrency(supplier.amount)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// 품목별 테이블 렌더링
function renderProductTable() {
    const tbody = $('productTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (productData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">품목 데이터가 없습니다.</td></tr>';
        return;
    }
    
    productData.forEach((product, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        row.innerHTML = `
            <td class="text-center font-medium">${product.rank}</td>
            <td class="font-medium">${product.product}</td>
            <td class="text-center">${formatNumber(product.contractCount)}</td>
            <td class="text-right font-medium amount">${formatCurrency(product.amount)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// 지역별 테이블 렌더링
function renderRegionTable() {
    const tbody = $('regionTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (regionData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">지역 데이터가 없습니다.</td></tr>';
        return;
    }
    
    regionData.forEach((region, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        row.innerHTML = `
            <td class="text-center font-medium">${region.rank}</td>
            <td class="font-medium">${region.region}</td>
            <td class="text-center">${formatNumber(region.supplierCount)}</td>
            <td class="text-center">${formatNumber(region.contractCount)}</td>
            <td class="text-right font-medium amount">${formatCurrency(region.amount)}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// 로딩 상태 표시
function showLoadingState(show) {
    isLoading = show;
    const analyzeBtn = $('analyzeBtn');
    if (analyzeBtn) {
        analyzeBtn.disabled = show;
        analyzeBtn.innerHTML = show 
            ? '<div class="loading-spinner"></div>분석 중...' 
            : `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
               </svg>분석`;
    }
    
    const statElements = ['totalSuppliers', 'totalContracts', 'totalSales'];
    statElements.forEach(id => {
        const element = $(id);
        if (element) {
            element.textContent = show ? '로딩중...' : element.textContent;
        }
    });
}

// 알림 표시
function showAlert(message, type = 'info') {
    if (window.CommonUtils && CommonUtils.showAlert) {
        CommonUtils.showAlert(message, type);
    } else {
        alert(message);
    }
}

// 테이블 정렬 함수
function sortTable(tbodyId, columnIndex, type = 'string') {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isAsc = tbody.dataset.sortColumn !== columnIndex.toString() || tbody.dataset.sortDirection === 'desc';
    
    const sortedRows = rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        let comparison = 0;

        if (type === 'number') {
            const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
            const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
            if (!isNaN(aNum) && !isNaN(bNum)) {
                comparison = aNum - bNum;
            }
        } else {
            comparison = aText.localeCompare(bText, 'ko-KR');
        }
        
        return isAsc ? comparison : -comparison;
    });
    
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
    
    tbody.dataset.sortColumn = columnIndex;
    tbody.dataset.sortDirection = isAsc ? 'asc' : 'desc';
}

// 전역 함수 노출
window.AgencyAnalysis = {
    analyzeData: analyzeData,
    sortTable: sortTable
};

console.log('=== AgencyAnalysis 모듈 로드 완료 ===');
